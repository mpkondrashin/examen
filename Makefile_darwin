#
# Sandboxer (c) 2024 by Mikhail Kondrashin (mkondrashin@gmail.com)
# Software is distributed under MIT license as stated in LICENSE file
#
# Makefile_darwin
#
# Makefile for MacOS
#
.PHONY: clean


GOOS=$(shell go env GOOS)
GOARCH=$(shell go env GOARCH)

REV=$(shell git rev-list --tags --max-count=1)
VERSION_FULL=$(shell git describe --tags $(REV))
VERSION_V := $(word 1,$(subst -, ,$(VERSION_FULL)))
VERSION := $(subst v,,$(VERSION_V))
ifeq ($(VERSION),)
VERSION := v
endif
BUILD = $(shell git rev-list --all --count)
ifeq ($(BUILD),)
BUILD := b
endif

setup_$(GOOS)_$(GOARCH).zip: Sandboxer.dmg
	zip setup_$(GOOS)_$(GOARCH).zip Sandboxer.dmg

Sandboxer.dmg: output/SandboxerInstall.app/Contents/MacOS/install
	hdiutil create -volname "Sandboxer" -srcfolder "output" -ov -format UDZO "Sandboxer.dmg"

output/SandboxerInstall.app/Contents/MacOS/install: $(wildcard cmd/install/*.go) $(wildcard pkg/*/*.go) pkg/globals/version.go cmd/sandboxer/icon.go  resources/icon.png cmd/install/embed/sandboxer.tar.gz cmd/install/embed/sandboxer_submit.tar.gz
	rm -rf output
	mkdir -p output
	fyne package --os darwin --name SandboxerInstall --appID in.kondrash.sandboxer --appVersion $(VERSION) --appBuild $(BUILD) --icon ../../resources/icon.png --release --sourceDir ./cmd/install
	mv SandboxerInstall.app output/SandboxerInstall.app

cmd/install/embed/sandboxer_submit.tar.gz: resources/sandboxer_submit.tar.gz
	cp resources/sandboxer_submit.tar.gz cmd/install/embed/sandboxer_submit.tar.gz

cmd/install/embed/sandboxer.tar.gz: Sandboxer.app
	tar cfvz $@ Sandboxer.app

Sandboxer.app: $(wildcard cmd/sandboxer/*.go) $(wildcard pkg/*/*.go) pkg/globals/version.go cmd/sandboxer/icon.go
	fyne package --os darwin --name Sandboxer --appID in.kondrash.sandboxer --appVersion $(VERSION) --appBuild $(BUILD) --icon ../../resources/icon.png --release --sourceDir ./cmd/sandboxer
#	rm -rf output
#	mkdir -p output
#	mv Sandboxer.app output

cmd/sandboxer/icon.go: resources/icon.png 
	fyne bundle --name ApplicationIcon --package main --output cmd/sandboxer/icon.go resources/icon.png 

output/Sandboxer.app/Contents/MacOS/submit: $(wildcard cmd/submit/*.go) $(wildcard pkg/*/*.go) pkg/globals/version.go
	go build -o ./output/Sandboxer.app/Contents/MacOS ./cmd/submit

pkg/globals/version.go: cmd/genver/main.go
	echo Version $(VERSION_V) $(BUILD)
	go run ./cmd/genver/main.go $(VERSION_V) $(BUILD) pkg/globals/version.go

clean:
	rm -rf output Sandboxer.dmg  
