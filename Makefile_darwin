#
# Sandboxer (c) 2024 by Mikhail Kondrashin (mkondrashin@gmail.com)
# Software is distributed under MIT license as stated in LICENSE file
#
# Makefile_darwin
#
# Makefile for MacOS
#
.PHONY: clean


GOOS=$(shell go env GOOS)
GOARCH=$(shell go env GOARCH)

REV=$(shell git rev-list --tags --max-count=1)
VERSION_FULL=$(shell git describe --tags $(REV))
VERSION_V := $(word 1,$(subst -, ,$(VERSION_FULL)))
VERSION := $(subst v,,$(VERSION_V))
ifeq ($(VERSION),)
VERSION := v
endif
BUILD = $(shell git rev-list --all --count)
ifeq ($(BUILD),)
BUILD := b
endif


setup_$(GOOS)_$(GOARCH).zip: Sandboxer.dmg
	zip setup_$(GOOS)_$(GOARCH).zip Sandboxer.dmg

Sandboxer.dmg: output/Sandboxer.app output/Sandboxer.app/Contents/MacOS/submit
	hdiutil create -volname "Sandboxer" -srcfolder "output" -ov -format UDZO "Sandboxer.dmg"

output/Sandboxer.app: $(wildcard cmd/sandboxer/*.go) $(wildcard pkg/*/*.go) pkg/globals/version.go cmd/sandboxer/icon.go cmd/sandboxer/embed/Sandboxer.tar.gz
	fyne package --os darwin --name Sandboxer --appID in.kondrash.sandboxer --appVersion $(VERSION) --appBuild $(BUILD) --icon ../../resources/icon.png --release --sourceDir ./cmd/sandboxer
	rm -rf output
	mkdir -p output
	mv Sandboxer.app output

cmd/sandboxer/embed/Sandboxer.tar.gz: resources/Sandboxer.tar.gz
	cp  resources/Sandboxer.tar.gz cmd/sandboxer/embed/Sandboxer.tar.gz

cmd/sandboxer/icon.go: resources/icon.png 
	fyne bundle --name ApplicationIcon --package main --output cmd/sandboxer/icon.go resources/icon.png 

output/Sandboxer.app/Contents/MacOS/submit: $(wildcard cmd/submit/*.go) $(wildcard pkg/*/*.go) pkg/globals/version.go
	go build -o ./output/Sandboxer.app/Contents/MacOS ./cmd/submit

pkg/globals/version.go: cmd/genver/main.go
	go run ./cmd/genver/main.go $(VERSION_V) $(BUILD) pkg/globals/version.go

clean:
	rm -rf output Sandboxer.dmg  
